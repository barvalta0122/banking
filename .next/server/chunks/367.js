"use strict";!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="e1b59a22-6a32-4aa4-9b79-10cf7f15d4bf",e._sentryDebugIdIdentifier="sentry-dbid-e1b59a22-6a32-4aa4-9b79-10cf7f15d4bf")}catch(e){}}(),function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="e1b59a22-6a32-4aa4-9b79-10cf7f15d4bf",e._sentryDebugIdIdentifier="sentry-dbid-e1b59a22-6a32-4aa4-9b79-10cf7f15d4bf")}catch(e){}}(),exports.id=367,exports.ids=[367],exports.modules={88367:function(e,t,n){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FetchInstrumentation=void 0;let i=s(n(65714)),r=n(76393),a=n(70862);class o{channelSubs;spanFromReq=new WeakMap;tracer;config;meter;instrumentationName="opentelemetry-instrumentation-node-18-fetch";instrumentationVersion="1.0.0";instrumentationDescription="Instrumentation for Node 18 fetch via diagnostics_channel";subscribeToChannel(e,t){let n=i.default.channel(e);n.subscribe(t),this.channelSubs.push({name:e,channel:n,onMessage:t})}constructor(e){fetch("").catch(()=>{}),this.channelSubs=[],this.meter=a.metrics.getMeter(this.instrumentationName,this.instrumentationVersion),this.tracer=a.trace.getTracer(this.instrumentationName,this.instrumentationVersion),this.config={...e}}disable(){this.channelSubs?.forEach(e=>e.channel.unsubscribe(e.onMessage))}enable(){this.subscribeToChannel("undici:request:create",e=>this.onRequest(e)),this.subscribeToChannel("undici:request:headers",e=>this.onHeaders(e)),this.subscribeToChannel("undici:request:trailers",e=>this.onDone(e)),this.subscribeToChannel("undici:request:error",e=>this.onError(e))}setTracerProvider(e){this.tracer=e.getTracer(this.instrumentationName,this.instrumentationVersion)}setMeterProvider(e){this.meter=e.getMeter(this.instrumentationName,this.instrumentationVersion)}setConfig(e){this.config={...e}}getConfig(){return this.config}onRequest({request:e}){if("CONNECT"===e.method||this.config.ignoreRequestHook&&!0===this.config.ignoreRequestHook(e))return;let t=this.tracer.startSpan(`HTTP ${e.method}`,{kind:a.SpanKind.CLIENT,attributes:{[r.SemanticAttributes.HTTP_URL]:function(e,t="/"){let n=`${e}`;return e.endsWith("/")&&t.startsWith("/")?`${n}${t.slice(1)}`:e.endsWith("/")||t.startsWith("/")?`${n}${t}`:`${n}/${t.slice(1)}`}(e.origin,e.path),[r.SemanticAttributes.HTTP_METHOD]:e.method,[r.SemanticAttributes.HTTP_TARGET]:e.path,"http.client":"fetch"}}),n=a.trace.setSpan(a.context.active(),t),s={};a.propagation.inject(n,s),this.config.onRequest&&this.config.onRequest({request:e,span:t,additionalHeaders:s}),Array.isArray(e.headers)?e.headers.push(...Object.entries(s).flat()):e.headers+=Object.entries(s).map(([e,t])=>`${e}: ${t}\r
`).join(""),this.spanFromReq.set(e,t)}onHeaders({request:e,response:t}){let n=this.spanFromReq.get(e);if(void 0!==n){let e=function(e){let t="content-length";for(let n=0;n<e.length;n+=2){let s=e[n];if(s.length===t.length&&s.toString().toLowerCase()===t){let t=Number(e[n+1]);if(!Number.isNaN(Number(t)))return t;break}}}(t.headers),s={[r.SemanticAttributes.HTTP_STATUS_CODE]:t.statusCode};e&&(s[r.SemanticAttributes.HTTP_RESPONSE_CONTENT_LENGTH]=e),n.setAttributes(s),n.setStatus({code:t.statusCode>=400?a.SpanStatusCode.ERROR:a.SpanStatusCode.OK,message:String(t.statusCode)})}}onDone({request:e}){let t=this.spanFromReq.get(e);void 0!==t&&(t.end(),this.spanFromReq.delete(e))}onError({request:e,error:t}){let n=this.spanFromReq.get(e);void 0!==n&&(n.recordException(t),n.setStatus({code:a.SpanStatusCode.ERROR,message:t instanceof AggregateError?t.errors.map(e=>e.message).join(", "):t.message}),n.end())}}t.FetchInstrumentation=o}};
//# sourceMappingURL=367.js.map